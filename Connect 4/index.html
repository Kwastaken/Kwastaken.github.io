<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <title>Document</title>
  </head>
  <body>
    <div id="game-container">
      <div class="cell" id="top"></div>
    </div>
    <button id="clear" class="button">Clear</button>
    <div class="button" id="bot">
      <label>Enable Bot</label><input type="checkbox" id="botToggle" />
    </div>

    <script>
      let row = 6;
      let col = 7;
      let move = 0;
      let yellow = [];
      let red = [];
      let colFilled = [6, 6, 6, 6, 6, 6, 6];
      //Create game on load
      for (let i = 1; i <= row * col; i++) {
        let divCreator = document.createElement("div");
        let position = [
          ((i - 1) % row) * 72 + 74,
          Math.floor((i - 1) / row) * 72 + 2,
        ];
        window.scrollTo(position[1], position[0]);
        divCreator.style.top = position[0] + "px";
        divCreator.style.left = position[1] + "px";
        divCreator.classList.add("cell");
        divCreator.setAttribute("data-cell", 3);
        divCreator.id = `${(i - 1) % row}${Math.floor((i - 1) / row)}`;
        /*divCreator.innerHTML = `${
          (((i - 1) % row) * 10 + Math.floor((i - 1) / row)) % 11
        }`;*/
        document.querySelector("#game-container").appendChild(divCreator);
      }
      //Handle the movement of the thingy at the top
      /*function topColor() {
        document.querySelector("#top").style.background =
          move % 2 == 1 ? "yellow" : "red";
      }
      document
        .querySelector("#game-container")
        .addEventListener("mousemove", (e) => {
          let offset = document.querySelector("#game-container").offsetLeft;
          if (e.clientX - offset < 32) {
            document.querySelector("#top").style.left = `2px`;
          } else if (e.clientX - offset > 466) {
            document.querySelector("#top").style.left = `434px`;
          } else {
            document.querySelector("#top").style.left = `${
              e.clientX - 32 - offset
            }px`;
          }
          topColor();
        });
      document
        .querySelector("#game-container")
        .addEventListener("mouseout", () => {
          document.querySelector("#top").style.background = "transparent";
        });*/
      //Runs game on click
      let div = document.querySelectorAll("[data-cell]");
      div.forEach((e) => {
        e.addEventListener("click", () => {
          let id = e.id;
          game(id);
          topColor();
        });
      });
      //Processes cell clicked and handles winner
      function game(id) {
        if (colFilled[id.charAt(1)] == 0) {
          return;
        }
        id = `${colFilled[id.charAt(1)] - 1}${id.charAt(1)}`;
        //console.log("id " + id);
        colFilled.splice(id.charAt(1), 1, colFilled[id.charAt(1)] - 1);
        //console.log(colFilled);
        if (move % 2 == 1) {
          document.getElementById(id).style.background = "yellow";
          yellow.push(id);
          if (winChecker(yellow, id) == "w") {
            setTimeout(() => {
              alert("Yellow winner");
            }, 50);
            return;
          }
        } else {
          document.getElementById(id).style.background = "red";
          red.push(id);
          if (winChecker(red, id) == "w") {
            move++;
            setTimeout(() => {
              alert("Red winner");
            }, 50);
            return;
          }
        }
        //console.log(red);
        //console.log(yellow);
        move++;
        if (document.querySelector("#botToggle").checked) {
          while (move % 2 == 1) {
            game(bot());
          }
        }
        if (move == 42) {
          setTimeout(() => {
            alert("Draw game");
          }, 50);
        }
      }
      //Checks for win
      function winChecker(moves, id) {
        let inARow = 0;
        let i;
        if (move < 0) {
          console.log("return");
          return;
        }
        //THIS IS ROW
        inARow = 0;
        for (i = 0; i <= 6; i++) {
          if (moves.includes(`${id.charAt(0)}${i}`)) {
            inARow++;
          } else {
            inARow = 0;
            if (i >= 3) {
              break;
            }
          }
          //console.log("RowCheck " + i);
          if (inARow == 4) {
            return "w";
          }
        }
        //THIS IS COLUMN
        if (id.charAt(0) <= 2) {
          inARow = 0;
          for (i = id.charAt(0); i <= id.charAt(0) + 3; i++) {
            if (moves.includes(`${i}${id.charAt(1)}`)) {
              inARow++;
            } else {
              inARow = 0;

              break;
            }
            //console.log("ColCheck " + i);
            if (inARow == 4) {
              return "w";
            }
          }
        }
        //THIS IS NE DIAGONAL UPPER
        if (id % 9 == 3 || id % 9 == 4 || id % 9 == 5) {
          inARow = 0;
          for (let i = id % 9; i >= 0; i--) {
            if (moves.includes(`${i}${(id % 9) - i}`)) {
              inARow++;
            } else {
              inARow = 0;
              if ((id % 9) - i >= 3) {
                break;
              }
            }
            //console.log("UNECheck" + i);
            if (inARow == 4) {
              return "w";
            }
          }
        }
        //THIS IS NE DIAGONAL LOWER
        if (id % 9 == 6 || id % 9 == 7 || id % 9 == 8) {
          inARow = 0;
          for (let i = (id % 9) - 5; i <= 6; i++) {
            if (moves.includes(`${(id % 9) - i}${i}`)) {
              inARow++;
            } else {
              inARow = 0;
              if (i >= 3) {
                break;
              }
            }
            //console.log("LNECheck " + i);
            if (inARow == 4) {
              return "w";
            }
          }
        }
        //THIS IS SE DIAGONAL LOWER
        if (id % 11 == 0 || id % 11 == 10 || id % 11 == 9) {
          inARow = 0;
          for (i = (11 - (id % 11)) % 11; i <= 5; i++) {
            if (moves.includes(`${i}${i - ((11 - (id % 11)) % 11)}`)) {
              inARow++;
            } else {
              inARow = 0;
              if (i - ((11 - (id % 11)) % 11) >= 3) {
                break;
              }
            }
            //console.log("LSECheck " + i);
            if (inARow == 4) {
              return "w";
            }
          }
        }
        //THIS IS SE DIAGONAL UPPER
        if (id % 11 == 1 || id % 11 == 2 || id % 11 == 3) {
          x = id % 11;
          inARow = 0;
          for (let i = id % 11; i <= 6; i++) {
            if (moves.includes(`${i - (id % 11)}${i}`)) {
              inARow++;
            } else {
              inARow = 0;
              if (i >= 3) {
                break;
              }
            }
            //console.log("USECheck " + i);
            if (inARow == 4) {
              return "w";
            }
          }
        }
        return "c";
      }
      //For automatic play
      function bot() {
        for (let b = 0; b <= 6; b++) {
          yellow.push(`${colFilled[b] - 1}${b}`);
          if (winChecker(yellow, `${colFilled[b] - 1}${b}`) == "w") {
            //console.log("yellow win");
            yellow.pop();
            return `${colFilled[b] - 1}${b}`;
          }
          yellow.pop();
        }
        for (let b = 0; b <= 6; b++) {
          red.push(`${colFilled[b] - 1}${b}`);
          if (winChecker(red, `${colFilled[b] - 1}${b}`) == "w") {
            //console.log("blocked red");
            red.pop();
            return `${colFilled[b] - 1}${b}`;
          }
          red.pop();
        }
        let losingMoves = [];
        let x;
        for (let b = 1; b <= colFilled.filter((e) => e != 0).length; b++) {
          while (
            losingMoves.includes(x) ||
            colFilled[x] == 0 ||
            x == undefined
          ) {
            x = Math.random();
            x = `${Math.floor(
              Math.pow(x - 0.5, 3) * 50 + (x - 0.5) * -5.5 + 3.5
            )}`;
          }
          red.push(`${colFilled[x] - 2}${x}`);
          if (winChecker(red, `${colFilled[x] - 2}${x}`) == "c") {
            //console.log("random but no lose");
            red.pop();
            return `${colFilled[x] - 1}${x}`;
          }
          losingMoves.push(x);
          red.pop();
        }
        //console.log("losing either way");
        return `${colFilled[x] - 1}${x}`;
      }
      //Clears board
      document.querySelector("#clear").addEventListener("click", () => {
        red.forEach((e) => {
          document.getElementById(e).style.background = "rgb(30, 30, 180)";
        });
        yellow.forEach((e) => {
          document.getElementById(e).style.background = "rgb(30, 30, 180)";
        });
        move = 0;
        yellow = [];
        red = [];
        colFilled = [6, 6, 6, 6, 6, 6, 6];
        red.forEach((e) => {
          document.getElementById(e).style.background = "red";
        });
        yellow.forEach((e) => {
          document.getElementById(e).style.background = "yellow";
        });
      });
    </script>
  </body>
</html>
